// Prisma schema for GodJira - Enterprise JIRA Clone
// Database: PostgreSQL 15+
// ORM: Prisma with UUID primary keys

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================
// ENUMS
// ===========================

enum UserRole {
  ADMIN
  MANAGER
  USER
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum IssueType {
  TASK
  BUG
  STORY
  EPIC
  SPIKE
}

enum IssueStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  DONE
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

// ===========================
// USER MODEL
// ===========================

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String   // bcrypt hashed, minimum 10 rounds
  name      String
  bio       String?  @db.Text
  jobTitle  String?
  department String?
  role      UserRole @default(USER)
  
  // Avatar stored as base64 data URL
  // Format: data:image/png;base64,iVBORw0KGgoAAAANS...
  avatar    String?  @db.Text
  
  isActive  Boolean  @default(true)
  
  // Password reset functionality
  resetToken          String?   @db.Text
  resetTokenExpiry    DateTime?
  
  // Password history for NIST compliance (prevent reuse)
  passwordHistory     String[]  @default([])
  
  // Account lockout tracking
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relationships
  ownedProjects    Project[]    @relation("ProjectOwner")
  createdTasks     Task[]       @relation("TaskCreator")
  assignedTasks    Task[]       @relation("TaskAssignee")
  createdIssues    Issue[]      @relation("IssueCreator")
  assignedIssues   Issue[]      @relation("IssueAssignee")
  comments         Comment[]
  workLogs         WorkLog[]
  
  @@index([email])
  @@map("users")
}

// ===========================
// PROJECT MODEL
// ===========================

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique // e.g., "WEB", "MOB" - used for issue prefixes
  name        String
  description String?  @db.Text
  
  ownerId     String   @db.Uuid
  owner       User     @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relationships
  sprints     Sprint[]
  issues      Issue[]
  tasks       Task[]
  
  @@index([key])
  @@index([ownerId])
  @@map("projects")
}

// ===========================
// SPRINT MODEL
// ===========================

model Sprint {
  id          String        @id @default(uuid()) @db.Uuid
  name        String
  goal        String?       @db.Text
  startDate   DateTime?
  endDate     DateTime?
  status      SprintStatus  @default(PLANNED)
  
  projectId   String        @db.Uuid
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Relationships
  issues      Issue[]
  
  @@index([projectId])
  @@index([status])
  @@map("sprints")
}

// ===========================
// ISSUE/TICKET MODEL
// ===========================

model Issue {
  id          String         @id @default(uuid()) @db.Uuid
  key         String         @unique // e.g., "WEB-123" (projectKey-number)
  title       String
  description String?        @db.Text // Rich text/markdown support
  
  type        IssueType      @default(TASK)
  status      IssueStatus    @default(BACKLOG)
  priority    IssuePriority  @default(MEDIUM)
  
  // Story points (Fibonacci scale: 1, 2, 3, 5, 8, 13, 21)
  storyPoints Int?
  
  // Attachments stored as base64 in database (screenshots, documents)
  attachments String[]       @default([]) @db.Text
  
  // Labels/tags for categorization (e.g., "Platform Team", "Developers")
  labels      String[]       @default([])
  
  // Relationships
  projectId   String         @db.Uuid
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  sprintId    String?        @db.Uuid
  sprint      Sprint?        @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  
  creatorId   String         @db.Uuid
  creator     User           @relation("IssueCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  
  assigneeId  String?        @db.Uuid
  assignee    User?          @relation("IssueAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  // Relationships
  comments    Comment[]
  workLogs    WorkLog[]
  
  @@index([key])
  @@index([projectId])
  @@index([sprintId])
  @@index([status])
  @@index([priority])
  @@index([creatorId])
  @@index([assigneeId])
  @@map("issues")
}

// ===========================
// COMMENT MODEL
// ===========================

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  content   String   @db.Text // Markdown support
  
  // Can belong to either Issue or Task
  issueId   String?  @db.Uuid
  issue     Issue?   @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  taskId    String?  @db.Uuid
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  authorId  String   @db.Uuid
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([issueId])
  @@index([taskId])
  @@index([authorId])
  @@map("comments")
}

// ===========================
// WORKLOG MODEL
// ===========================

model WorkLog {
  id          String   @id @default(uuid()) @db.Uuid
  description String   @db.Text
  timeSpent   Int      // Time in minutes
  logDate     DateTime @default(now())
  
  issueId     String   @db.Uuid
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  userId      String   @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([issueId])
  @@index([userId])
  @@index([logDate])
  @@map("work_logs")
}

// ===========================
// TASK MODEL (Legacy Support)
// ===========================

model Task {
  id          String       @id @default(uuid()) @db.Uuid
  title       String
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  
  projectId   String       @db.Uuid
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  creatorId   String       @db.Uuid
  creator     User         @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  
  assigneeId  String?      @db.Uuid
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relationships
  comments    Comment[]
  
  @@index([projectId])
  @@index([status])
  @@index([creatorId])
  @@index([assigneeId])
  @@map("tasks")
}
