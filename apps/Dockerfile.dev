# Development Dockerfile for GodJira API
# Using Debian-based Node instead of Alpine to avoid bcrypt native module issues
FROM node:20-slim

# Install system dependencies and build tools
RUN apt-get update && apt-get install -y \
    git \
    curl \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally
RUN npm install -g pnpm@9

# Set working directory
WORKDIR /app

# Copy workspace configuration
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./

# Copy all workspace packages (monorepo)
COPY apps ./apps

# Install ALL dependencies (including devDependencies)
RUN pnpm install --frozen-lockfile

# Generate Prisma Client
WORKDIR /app/apps
RUN pnpm prisma generate

# Create uploads directory
RUN mkdir -p /app/uploads && chmod 755 /app/uploads

# Expose API port
EXPOSE 3000

# Expose debug port for Node.js inspector
EXPOSE 9229

# Set working directory to API
WORKDIR /app/apps

# Default command: start in watch mode (hot-reload)
CMD ["pnpm", "dev"]

